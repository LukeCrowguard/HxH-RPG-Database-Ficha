<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hunter Database | Supabase Edition</title>
    <meta name="theme-color" content="#050506">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚔️</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&family=Shojumaru&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'hxh-dark': '#050506',
              'hxh-panel': '#131316',
              'theme': 'var(--theme-color)',
            },
            fontFamily: {
              'title': ['Shojumaru', 'cursive'],
              'header': ['Cinzel', 'serif'],
              'tech': ['Orbitron', 'sans-serif'],
              'body': ['Lato', 'sans-serif'],
            },
            animation: {
              'fade-in': 'fadeIn 0.5s ease-out forwards',
              'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
              'float': 'float 10s ease-in-out infinite',
              'aura': 'aura 3s infinite alternate',
              'spin-slow': 'spin 15s linear infinite',
              'spin-reverse': 'spin 20s linear infinite reverse',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-20px)' } },
              aura: { 
                '0%': { boxShadow: '0 0 20px var(--theme-color), 0 0 40px var(--theme-color)' },
                '100%': { boxShadow: '0 0 40px var(--theme-color), 0 0 80px var(--theme-color)' }
              }
            }
          }
        }
      }
    </script>
    
    <style>
      :root {
        --theme-color: #9b59b6;
      }
      body {
        background-color: #020203;
        color: #e0e0e0;
        overflow-x: hidden;
        perspective: 1000px;
        font-family: 'Lato', sans-serif;
      }
      
      /* --- 3D Background Effects --- */
      .world-container {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        overflow: hidden;
        z-index: -1;
        background: radial-gradient(circle at center, #130a1f 0%, #000000 90%);
      }

      .perspective-grid {
        position: absolute;
        bottom: -30%;
        left: -50%;
        width: 200%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(155,89,182,0.4) 1px, transparent 1px),
            linear-gradient(90deg, rgba(155,89,182,0.4) 1px, transparent 1px);
        background-size: 60px 60px;
        transform: perspective(500px) rotateX(60deg);
        animation: grid-scroll 3s linear infinite;
        opacity: 0.25;
        box-shadow: 0 0 100px rgba(155,89,182, 0.2);
        mask-image: linear-gradient(to top, black 40%, transparent 95%);
        -webkit-mask-image: linear-gradient(to top, black 40%, transparent 95%);
      }

      @keyframes grid-scroll {
        0% { background-position: 0 0; }
        100% { background-position: 0 60px; }
      }

      .cube {
        position: absolute;
        width: 40px; height: 40px;
        transform-style: preserve-3d;
        animation: spin-cube 10s linear infinite;
        opacity: 0.1;
      }
      .cube div {
        position: absolute;
        width: 40px; height: 40px;
        border: 1px solid var(--theme-color);
        background: rgba(155,89,182, 0.1);
      }
      .front  { transform: translateZ(20px); }
      .back   { transform: rotateY(180deg) translateZ(20px); }
      .right  { transform: rotateY(90deg) translateZ(20px); }
      .left   { transform: rotateY(-90deg) translateZ(20px); }
      .top    { transform: rotateX(90deg) translateZ(20px); }
      .bottom { transform: rotateX(-90deg) translateZ(20px); }

      @keyframes spin-cube {
        0% { transform: rotateX(0) rotateY(0); }
        100% { transform: rotateX(360deg) rotateY(360deg); }
      }

      /* --- UI Components --- */

      .glass-panel {
        background: rgba(10, 10, 14, 0.7);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
        border-radius: 6px;
        position: relative;
      }
      
      .glass-panel::before {
        content: '';
        position: absolute;
        top: 0; left: 0; width: 100%; height: 1px;
        background: linear-gradient(90deg, transparent, var(--theme-color), transparent);
        opacity: 0.8;
        pointer-events: none;
      }

      .neon-border {
        box-shadow: 0 0 10px rgba(155,89,182, 0.1), inset 0 0 20px rgba(155,89,182, 0.05);
        border: 1px solid rgba(155,89,182, 0.3);
      }
      
      .text-glow { text-shadow: 0 0 10px currentColor; }
      .box-glow { box-shadow: 0 0 15px rgba(155,89,182, 0.2); }

      .avatar-container {
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.5s;
      }
      .avatar-container:hover {
        transform: rotateY(2deg) rotateX(2deg);
      }
      
      .nen-aura {
        position: absolute;
        inset: -5px;
        background: var(--theme-color);
        filter: blur(20px);
        opacity: 0.4;
        z-index: -1;
        animation: aura-pulse 3s infinite alternate;
        border-radius: 50%;
      }
      @keyframes aura-pulse {
        0% { opacity: 0.2; transform: scale(0.95); }
        100% { opacity: 0.6; transform: scale(1.05); }
      }

      /* Scrollbars */
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--theme-color); }
      
      .hide-scroll::-webkit-scrollbar { display: none; }
      .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

      /* Inputs */
      input, textarea, select {
        background: transparent;
        color: inherit;
        border: none;
        outline: none;
      }
      .edit-mode input, .edit-mode textarea, .edit-mode select {
        background: rgba(0,0,0,0.6);
        border-bottom: 1px solid var(--theme-color);
        border-radius: 4px;
        padding: 4px 8px;
        transition: all 0.3s;
      }
      .edit-mode input:focus, .edit-mode textarea:focus {
        background: rgba(155,89,182, 0.2);
        box-shadow: 0 0 10px rgba(155,89,182, 0.2);
      }
    </style>
  </head>
  <body>
    <!-- 3D Background Layer -->
    <div class="world-container">
        <div class="perspective-grid"></div>
        <!-- 3D Cubes -->
        <div class="cube" style="top: 20%; left: 15%;">
            <div class="front"></div><div class="back"></div><div class="right"></div><div class="left"></div><div class="top"></div><div class="bottom"></div>
        </div>
        <div class="cube" style="top: 60%; right: 20%; animation-delay: -5s;">
             <div class="front"></div><div class="back"></div><div class="right"></div><div class="left"></div><div class="top"></div><div class="bottom"></div>
        </div>
        
        <!-- Decorative 3D Runes -->
        <div style="position: absolute; top: 10%; left: 5%; font-size: 10rem; opacity: 0.05; transform: rotate(-10deg); font-family: 'Shojumaru'; color: white; pointer-events: none;">念</div>
        <div style="position: absolute; bottom: 20%; right: 10%; font-size: 15rem; opacity: 0.05; transform: rotate(10deg); font-family: 'Shojumaru'; color: white; pointer-events: none;">絶</div>
    </div>

    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-presets="react, typescript" data-type="module">
      import React, { useState, useRef, useEffect } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { 
        Shield, Zap, Heart, Sword, Brain, Activity, Ghost, Feather, Dna, 
        Dice5, Trash2, Edit3, Save, Plus, X, Camera, ScrollText, Box,
        Users, Upload, Share2, Copy, Hexagon,
        Monitor, Target, PawPrint, Terminal, ChevronRight, ImageIcon, BatteryCharging, Sparkles,
        AlertCircle, Calculator, Info, Lock, ChevronUp, ChevronDown, Menu, ShieldCheck, Minimize2
      } from 'https://esm.sh/lucide-react@0.294.0';
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.39.3';

      // --- SUPABASE SETUP ---
      const SUPABASE_URL = 'https://cdxdpjodsyknyaojjbig.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkeGRwam9kc3lrbnlhb2pqYmlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0MTEwNjEsImV4cCI6MjA4Mjk4NzA2MX0.jus2sDdvS41bV4o4JTio3ph4AkmuX4asui-U3SbvIqU';
      
      let supabase = null;
      try {
          supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch(e) { console.error("Supabase init failed:", e); }

      // --- UTILS ---
      const rollDice = (diceStr) => {
        try {
            if(!diceStr) return { total: 0, rolls: [], str: diceStr };
            const [count, die] = diceStr.toLowerCase().split('d').map(Number);
            if(!count || !die) return { total: 0, rolls: [], str: diceStr };
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) {
                const r = Math.floor(Math.random() * die) + 1;
                rolls.push(r);
                total += r;
            }
            return { total, rolls, str: diceStr };
        } catch (e) { return { total: 0, rolls: [], str: diceStr }; }
      };

      const resizeImage = (file, maxWidth = 800) => {
        return new Promise((resolve, reject) => {
            if (!file || !file.type.startsWith('image/')) {
                reject("Arquivo inválido. Selecione uma imagem.");
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round(height * (maxWidth / width));
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.85)); 
                    } catch (err) {
                        resolve(event.target.result); 
                    }
                };
                img.onerror = (error) => reject("Erro ao carregar imagem.");
            };
            reader.onerror = (error) => reject("Erro ao ler arquivo.");
        });
      };
      
      const generateUUID = () => {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
            return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
      };

      const NenType = {
        Enhancer: 'Reforço',
        Transmuter: 'Transformação',
        Emitter: 'Emissão',
        Conjurer: 'Materialização',
        Manipulator: 'Manipulação',
        Specialist: 'Especialização',
      };

      const NEN_COLORS = {
        [NenType.Enhancer]: '#2ecc71', 
        [NenType.Transmuter]: '#d500f9', 
        [NenType.Emitter]: '#29b6f6',
        [NenType.Conjurer]: '#ff1744', 
        [NenType.Manipulator]: '#ff6d00',
        [NenType.Specialist]: '#ffea00',
      };
      
      const ATTR_COLORS = { strength: '#c0392b', intelligence: '#8e44ad', charisma: '#27ae60', determination: '#f1c40f', constitution: '#2980b9', prestidigitation: '#e67e22' };
      const PALETTE = ['#e74c3c', '#8e44ad', '#3498db', '#f1c40f', '#2ecc71', '#e67e22', '#1abc9c', '#9b59b6', '#34495e'];
      const getColor = (key, index) => ATTR_COLORS[key] || PALETTE[index % PALETTE.length];
      const ATTR_ICONS = { strength: Sword, intelligence: Brain, charisma: Feather, determination: Dna, constitution: Activity, prestidigitation: Ghost };

      const INITIAL_CHARACTER = {
        id: '123e4567-e89b-12d3-a456-426614174000', // Valid UUID for template
        name: "Cristian Martínez",
        nickname: "'Hades'",
        avatarUrl: "https://i.pinimg.com/736x/8e/46/64/8e4664440076a084c7873994c657a827.jpg", 
        age: 18,
        nationality: "Peruano",
        height: "1.72 m",
        weight: "64 kg",
        alignment: "Neutro-Neutro",
        bio: "Hades cresceu nas ruas de Meteor City...",
        hunterLevel: 5,
        xp: 250,
        maxXp: 600,
        nenType: NenType.Specialist, 
        maxHp: 34, currentHp: 34, maxNen: 58, currentNen: 33, ca: 15,
        attributes: { strength: -2, constitution: -2, intelligence: 0, charisma: -3, determination: 3, prestidigitation: 5 },
        attributeLabels: { strength: 'Força', constitution: 'Constituição', intelligence: 'Inteligência', charisma: 'Carisma', determination: 'Determinação', prestidigitation: 'Destreza' },
        attributeMetadata: {}, 
        equippedWeapon: { name: 'Foice de Nen', damage: '1d10', description: 'Uma foice materializada que drena aura.', powers: 'Ao acertar um crítico, recupera 1d4 de Nen.', imageUrl: '' },
        skills: [
            { id: '1', name: 'Força de Pulso', category: 'Weapon', type: 'Ativa', cost: 2, costType: 'Nen', damageDice: '1d8', attributeScaling: 'determination', description: 'Golpeia o ar criando uma onda de choque.', imageUrl: 'https://i.pinimg.com/564x/4d/2e/77/4d2e77987823e595df5057a151859c2c.jpg' },
            { id: '2', name: 'Passo Sombrio', category: 'Combat', type: 'Bônus', cost: 0, costType: 'Nen', damageDice: '2d6', attributeScaling: 'prestidigitation', description: 'Movimentação silenciosa. Vantagem no ataque.', imageUrl: '' },
            { id: '3', name: 'Sacrifício de Sangue', category: 'Hatsu', type: 'Ativa', cost: 5, costType: 'HP', damageDice: '3d6', attributeScaling: '', description: 'Sacrifica vitalidade para causar dano massivo.', imageUrl: '' },
        ],
        inventory: [
            { id: 'i1', name: "Espada Curta", quantity: 1 },
            { id: 'i2', name: "Poção de Cura", quantity: 2 },
            { id: 'i3', name: "Licença Hunter", quantity: 1 }
        ],
        summons: [
             { id: 's1', name: 'Guardião Sombrio', avatarUrl: 'https://i.pinimg.com/564x/0a/65/59/0a6559385b0451df6718d09794025171.jpg', type: 'Besta de Nen', currentHp: 20, maxHp: 20, currentNen: 10, maxNen: 10, attributes: { strength: 3, constitution: 2, intelligence: -2, charisma: -3, determination: 4, prestidigitation: 2 }, description: 'Um lobo feito de sombras.', skills: [
                 { id: 's1k1', name: 'Mordida Sombria', cost: 2, costType: 'Nen', damage: '1d6', description: 'Ataque rápido com as presas.' }
             ] }
        ],
        conditions: ['Ren', 'Furtividade']
      };

      // --- SUB-COMPONENTS ---

      const StatBar = ({ label, current, max, color, icon, isEditing, onChange, onMaxChange, onOpenCalculator }) => {
        const percentage = Math.min(100, Math.max(0, (current / max) * 100));
        return (
            <div className="flex flex-col w-full mb-4 group relative z-10">
                <div className="flex justify-between items-end mb-2">
                    <div className="flex items-center gap-2 font-tech text-[10px] font-bold uppercase tracking-[0.2em] opacity-90" style={{color: color, textShadow: `0 0 10px ${color}`}}>
                        {icon} <span>{label}</span>
                    </div>
                    <div className="flex items-center text-lg font-bold font-mono text-white">
                        {!isEditing && (
                            <button onClick={onOpenCalculator} className="mr-2 text-gray-500 hover:text-white transition-colors opacity-50 hover:opacity-100 z-20 relative">
                                <Calculator size={14} />
                            </button>
                        )}
                        <input type="number" value={current} onChange={(e) => onChange && onChange(parseInt(e.target.value) || 0)} className="w-12 bg-transparent text-right outline-none text-white font-bold border-b border-transparent focus:border-white/50 relative z-20" />
                        <span className="mx-1 text-gray-600">/</span>
                        {isEditing ? <input type="number" value={max} onChange={(e) => onMaxChange && onMaxChange(parseInt(e.target.value) || 0)} className="w-12 bg-white/5 rounded px-1 text-center outline-none border border-white/10 text-white relative z-20"/> : <span className="text-gray-500 w-12 text-center">{max}</span>}
                    </div>
                </div>
                <div className="relative h-4 bg-black/60 border border-white/10 rounded-full overflow-hidden shadow-[inset_0_2px_5px_rgba(0,0,0,0.8)]">
                    <div className="h-full transition-all duration-700 ease-out relative z-10" style={{ width: `${percentage}%`, background: `linear-gradient(180deg, ${color}60 0%, ${color} 50%, ${color}30 100%)`, boxShadow: `0 0 20px ${color}` }}>
                        <div className="absolute top-1 left-0 right-0 h-[2px] bg-white/40 blur-[1px]"></div>
                    </div>
                </div>
            </div>
        );
      };

      const CalculatorModal = ({ isOpen, onClose, target, onConfirm }) => {
          const [value, setValue] = useState('');
          useEffect(() => { if (isOpen) setValue(''); }, [isOpen]);
          if (!isOpen || !target) return null;

          const handleApply = (type) => {
              const numVal = parseInt(value) || 0;
              if (numVal === 0) return;
              onConfirm(type === 'sub' ? -numVal : numVal);
              onClose();
          };
          const isHp = target.field.toLowerCase().includes('hp');
          
          return (
            <div className="fixed inset-0 z-[110] flex items-center justify-center bg-black/80 backdrop-blur-md p-4 animate-fade-in" style={{zIndex: 110}}>
                <div className="glass-panel w-full max-w-xs p-8 neon-border relative flex flex-col items-center shadow-[0_0_50px_rgba(0,0,0,0.8)]">
                    <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-white transition-colors z-20"><X size={20}/></button>
                    <h3 className="text-xs font-tech text-theme uppercase tracking-[0.2em] mb-4 text-glow">{target.label}</h3>
                    
                    <div className="text-5xl font-mono font-bold text-white mb-6 flex items-baseline gap-2 drop-shadow-lg">
                        <span>{target.current}</span>
                        <span className="text-xl text-gray-600">/</span>
                        <span className="text-xl text-gray-500">{target.max}</span>
                    </div>

                    <div className="w-full bg-black/60 border border-white/20 p-4 mb-6 flex items-center justify-center rounded-lg relative z-10 shadow-inner">
                         <input type="number" autoFocus placeholder="0" className="bg-transparent text-center text-4xl font-mono text-white w-full placeholder-gray-700 focus:outline-none"
                            value={value} onChange={(e) => setValue(e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') handleApply('sub'); }} />
                    </div>

                    <div className="flex gap-2 mb-6 w-full justify-center relative z-10">
                        {[1, 5, 10, 50].map(v => (
                            <button key={v} onClick={() => setValue(v)} className="bg-white/5 hover:bg-white/20 border border-white/10 text-xs font-mono py-2 px-4 rounded text-gray-400 hover:text-white transition-colors">{v}</button>
                        ))}
                    </div>

                    <div className="grid grid-cols-2 gap-4 w-full relative z-10">
                        <button onClick={() => handleApply('sub')} className={`py-4 ${isHp ? 'bg-red-500/10 hover:bg-red-500/30 border-red-500/50 text-red-400' : 'bg-orange-500/10 hover:bg-orange-500/30 border-orange-500/50 text-orange-400'} border rounded font-bold uppercase text-[10px] tracking-widest transition-all active:scale-95 shadow-lg`}>
                            {isHp ? 'Dano (-)' : 'Gastar (-)'}
                        </button>
                        <button onClick={() => handleApply('add')} className={`py-4 ${isHp ? 'bg-green-500/10 hover:bg-green-500/30 border-green-500/50 text-green-400' : 'bg-blue-500/10 hover:bg-blue-500/30 border-blue-500/50 text-blue-400'} border rounded font-bold uppercase text-[10px] tracking-widest transition-all active:scale-95 shadow-lg`}>
                            {isHp ? 'Curar (+)' : 'Recuperar (+)'}
                        </button>
                    </div>
                </div>
            </div>
          );
      };

      const AttributeCard = ({ label, value, icon: Icon, imageUrl, color, isEditing, onRoll, onChange, onLabelChange, onUpload, onDelete }) => {
        return (
            <div className="relative w-full aspect-square flex flex-col items-center justify-center p-2 group cursor-pointer" onClick={!isEditing ? onRoll : undefined}>
                 <div className="absolute inset-0 rounded-full border border-white/5 bg-black/40 shadow-[0_0_20px_rgba(0,0,0,0.5)] overflow-hidden transition-all duration-500 group-hover:border-white/20 group-hover:shadow-[0_0_30px_var(--attr-color)] group-hover:scale-105" style={{'--attr-color': color}}>
                     <div className="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent opacity-50"></div>
                     <div className="absolute inset-0 animate-spin-slow opacity-30">
                         <svg viewBox="0 0 100 100" className="w-full h-full">
                             <circle cx="50" cy="50" r="45" stroke={color} strokeWidth="1" fill="none" strokeDasharray="20 10" />
                             <circle cx="50" cy="50" r="35" stroke={color} strokeWidth="0.5" fill="none" strokeDasharray="5 5" />
                         </svg>
                     </div>
                 </div>

                 <div className="relative z-10 flex flex-col items-center justify-center w-full h-full">
                     <div className="w-10 h-10 mb-2 relative flex items-center justify-center">
                         {imageUrl ? (
                             <div className="w-10 h-10 rounded-full overflow-hidden border border-white/30 shadow-[0_0_10px_var(--attr-color)] relative z-10 bg-black">
                                 <img src={imageUrl} className="w-full h-full object-cover" />
                             </div>
                         ) : (
                             <div className="drop-shadow-[0_0_10px_var(--attr-color)] transition-transform duration-300 group-hover:scale-110" style={{color}}>
                                 {Icon ? <Icon size={28} /> : <Zap size={28} />}
                             </div>
                         )}
                         {isEditing && onUpload && (
                             <button onClick={(e) => { e.stopPropagation(); onUpload(); }} className="absolute -bottom-2 -right-2 bg-black/80 text-white p-1 rounded-full border border-white/20 hover:bg-white hover:text-black transition-colors z-20 shadow-lg"><Upload size={10} /></button>
                         )}
                     </div>
                     {isEditing ? (
                         <input type="number" value={value} onClick={e => e.stopPropagation()} onChange={(e) => onChange(parseInt(e.target.value) || 0)} className="w-16 bg-transparent text-center text-white font-mono text-2xl font-bold border-b border-white/20 outline-none" />
                     ) : (
                         <span className="text-3xl font-mono font-bold text-white drop-shadow-[0_0_5px_rgba(0,0,0,0.8)] transition-all duration-300 group-hover:text-glow" style={{textShadow: `0 0 15px ${color}`}}>
                             {value >= 0 ? `+${value}` : value}
                         </span>
                     )}
                     {isEditing ? (
                         <input value={label} onClick={e => e.stopPropagation()} onChange={e => onLabelChange(e.target.value)} className="text-[10px] font-tech uppercase tracking-widest text-gray-400 mt-1 text-center w-full bg-transparent border-b border-white/10" />
                     ) : (
                         <span className="text-[9px] font-tech uppercase tracking-[0.2em] text-gray-400 mt-1 text-center group-hover:text-white transition-colors">{label}</span>
                     )}
                     {isEditing && onDelete && (
                         <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="absolute top-1 right-1 text-red-500 hover:text-white bg-black/50 rounded-full p-1 transition-colors z-30"><X size={10} /></button>
                     )}
                 </div>
            </div>
        );
      };

      const AttributesRadar = ({ attributes, labels, size = 200, color }) => {
        const keys = Object.keys(attributes);
        const count = keys.length;
        if(count < 3) return null;

        const center = size / 2;
        const radius = size * 0.35; 
        const maxVal = 10; const minVal = -2; const range = maxVal - minVal;

        const getPoint = (val, i) => {
            const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
            const normalized = Math.max(0, (Math.min(maxVal, val) - minVal) / range);
            const r = radius * normalized;
            return [center + Math.cos(angle) * r, center + Math.sin(angle) * r];
        };
        const polyPoints = keys.map((k, i) => getPoint(attributes[k], i).join(',')).join(' ');

        return (
            <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`} className="overflow-visible select-none pointer-events-none drop-shadow-[0_0_15px_rgba(0,0,0,0.8)]">
                <defs><filter id="radar-glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                {[0.25, 0.5, 0.75, 1].map((scale, idx) => (
                    <polygon key={idx} points={keys.map((_, i) => {
                        const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                        return `${center + Math.cos(angle) * radius * scale},${center + Math.sin(angle) * radius * scale}`;
                    }).join(' ')} fill="none" stroke="rgba(255,255,255,0.05)" strokeDasharray={idx === 3 ? "0" : "2 2"} />
                ))}
                {keys.map((k, i) => {
                     const angle = (Math.PI * 2 * i) / count - Math.PI / 2;
                     const labelRadius = radius + 25;
                     const lx = center + Math.cos(angle) * labelRadius;
                     const ly = center + Math.sin(angle) * labelRadius;
                     const Icon = ATTR_ICONS[k] || Sparkles;
                     const attrColor = getColor(k, i);
                     const val = attributes[k];
                     const valText = val >= 0 ? `+${val}` : val;
                     return (
                        <g key={i}>
                            <line x1={center} y1={center} x2={center + Math.cos(angle) * radius} y2={center + Math.sin(angle) * radius} stroke="rgba(255,255,255,0.05)" />
                            <foreignObject x={lx - 10} y={ly - 10} width={20} height={20}>
                                <div className="flex items-center justify-center w-full h-full"><Icon size={14} style={{color: attrColor}} /></div>
                            </foreignObject>
                            <text x={lx} y={ly + 12} textAnchor="middle" dominantBaseline="middle" fill={attrColor} fontSize="10" className="font-mono font-bold" style={{textShadow: `0 0 5px ${attrColor}`}}>{valText}</text>
                        </g>
                     )
                })}
                <polygon points={polyPoints} fill={color} fillOpacity="0.3" stroke={color} strokeWidth="2" style={{filter: 'url(#radar-glow)'}} className="transition-all duration-500"/>
                {keys.map((k, i) => {
                    const [x, y] = getPoint(attributes[k], i);
                    return <circle key={i} cx={x} cy={y} r="3" fill="white" className="transition-all duration-500 shadow-lg"/>
                })}
            </svg>
        )
      };

      const NenHexagon = ({ activeType, size = 160 }) => {
        const typeOrder = [NenType.Enhancer, NenType.Transmuter, NenType.Conjurer, NenType.Specialist, NenType.Manipulator, NenType.Emitter];
        const points = [{ x: 50, y: 10, l:'Reforço' }, { x: 84.6, y: 30, l:'Trans.' }, { x: 84.6, y: 70, l:'Mat.' }, { x: 50, y: 90, l:'Esp.' }, { x: 15.4, y: 70, l:'Man.' }, { x: 15.4, y: 30, l:'Emis.' }];
        
        const getEfficiencies = (type) => {
            const index = typeOrder.indexOf(type);
            return typeOrder.map((t, i) => {
                if (type === NenType.Specialist) return t === NenType.Specialist ? 1.0 : (t === NenType.Conjurer || t === NenType.Manipulator ? 0.8 : (t === NenType.Enhancer ? 0.4 : 0.6));
                if (t === NenType.Specialist) return 0.0;
                let dist = Math.abs(index - i);
                if (dist > 3) dist = 6 - dist;
                return Math.max(0, 1.0 - (dist * 0.2));
            });
        };
        const efficiencies = getEfficiencies(activeType);
        const activeColor = NEN_COLORS[activeType] || '#fff';
        const polyPoints = points.map((p, i) => {
            const eff = Math.max(0.1, efficiencies[i]);
            return `${50 + (p.x - 50) * eff},${50 + (p.y - 50) * eff}`;
        }).join(' ');

        return (
            <div className="relative flex items-center justify-center pointer-events-none" style={{width: size, height: size}}>
                 <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible drop-shadow-[0_0_20px_rgba(0,0,0,0.8)]">
                    <defs><filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
                    <polygon points={points.map(p => `${p.x},${p.y}`).join(' ')} fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="0.5" strokeDasharray="2 2"/>
                    <polygon points={points.map(p => `${50 + (p.x - 50) * 0.6},${50 + (p.y - 50) * 0.6}`).join(' ')} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="0.5"/>
                    {points.map((p, i) => (
                        <g key={i}>
                            <text x={p.x} y={p.y < 50 ? p.y - 6 : p.y + 12} textAnchor="middle" fontSize="6" fill={efficiencies[i] === 1 ? activeColor : '#666'} className="font-tech font-bold uppercase tracking-wide" style={{textShadow: efficiencies[i]===1 ? `0 0 5px ${activeColor}` : 'none'}}>{p.l}</text>
                            <text x={p.x} y={p.y < 50 ? p.y - 13 : p.y + 18} textAnchor="middle" fontSize="4" fill={efficiencies[i] > 0 ? '#888' : '#333'} className="font-mono">{(efficiencies[i]*100).toFixed(0)}%</text>
                        </g>
                    ))}
                    <polygon points={polyPoints} fill={activeColor} fillOpacity="0.2" stroke={activeColor} strokeWidth="2" strokeLinejoin="round" style={{ filter: 'url(#glow)' }} className="transition-all duration-700"/>
                    <circle cx="50" cy="50" r="1.5" fill="white" opacity="0.8"/>
                </svg>
            </div>
        );
      }

      // --- APP COMPONENT ---

      const App = () => {
        const [characters, setCharacters] = useState([INITIAL_CHARACTER]);
        const [activeCharId, setActiveCharId] = useState(INITIAL_CHARACTER.id);
        const [loading, setLoading] = useState(true);
        const [isSaving, setIsSaving] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [logs, setLogs] = useState([]);
        const [isCharModalOpen, setIsCharModalOpen] = useState(false);
        const [activeTab, setActiveTab] = useState('hatsus');
        const [consoleExpanded, setConsoleExpanded] = useState(true);
        const [uploadTarget, setUploadTarget] = useState(null); 
        const [conditionInput, setConditionInput] = useState("");
        const [calculatorTarget, setCalculatorTarget] = useState(null); 
        
        const fileInputRef = useRef(null);
        const logsEndRef = useRef(null);

        // Load Data from Supabase
        useEffect(() => {
            const load = async () => {
                if(!supabase) {
                    console.warn("Supabase not configured");
                    setLoading(false);
                    return;
                }
                try {
                    const { data, error } = await supabase.from('characters').select('*').order('updated_at', {ascending: false});
                    if(!error && data && data.length > 0) {
                        const loadedChars = data.map(d => ({...d.data, id: d.id}));
                        setCharacters(loadedChars);
                        setActiveCharId(loadedChars[0].id);
                    }
                } catch(e) { console.error(e); }
                finally { setLoading(false); }
            };
            load();
        }, []);

        useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [logs]);

        // Handlers
        const handleStateUpdate = (newCharsFn) => {
            setCharacters(prev => {
                const newState = typeof newCharsFn === 'function' ? newCharsFn(prev) : newCharsFn;
                return newState;
            });
        };

        const updateChar = (field, value) => handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [field]: value } : c));
        
        const updateNested = (collection, idOrKey, newData) => {
            handleStateUpdate(prev => prev.map(c => {
                if (c.id !== activeCharId) return c;
                if (collection === 'attributes') return { ...c, attributes: { ...c.attributes, [idOrKey]: newData } };
                if (collection === 'equippedWeapon') return { ...c, equippedWeapon: { ...c.equippedWeapon, [idOrKey]: newData } };
                const list = c[collection] || [];
                const updatedList = list.map(item => item.id === idOrKey ? { ...item, ...newData } : item);
                return { ...c, [collection]: updatedList };
            }));
        };

        const handleSave = async () => {
            setIsSaving(true);
            const charToSave = characters.find(c => c.id === activeCharId);
            if(supabase && charToSave) {
                const { error } = await supabase.from('characters').upsert({
                    id: charToSave.id,
                    data: charToSave,
                    updated_at: new Date()
                });
                if(error) alert("Erro ao salvar: " + error.message);
                else addLog("Sistema", "Salvo", "Dados sincronizados com o banco");
            } else {
                alert("Supabase não configurado ou personagem inválido.");
            }
            setIsSaving(false);
            setIsEditing(false);
        };

        const handleDelete = async (id) => {
            if(!confirm("Deletar personagem?")) return;
            if(supabase) await supabase.from('characters').delete().eq('id', id);
            const rem = characters.filter(c => c.id !== id);
            if(rem.length === 0) {
                setCharacters([INITIAL_CHARACTER]);
                setActiveCharId(INITIAL_CHARACTER.id);
            } else {
                setCharacters(rem);
                setActiveCharId(rem[0].id);
            }
        };

        const addLog = (title, result, detail, type = 'info') => {
            setLogs(prev => [...prev, { id: Math.random(), title, result, detail, type, time: new Date() }]);
        };

        const char = characters.find(c => c.id === activeCharId) || INITIAL_CHARACTER;
        const themeColor = NEN_COLORS[char.nenType] || '#9b59b6';
        const equippedWeapon = char.equippedWeapon || { name: 'Desarmado', damage: '1d4', description: '', powers: '', imageUrl: '' };
        const attrLabels = char.attributeLabels || INITIAL_CHARACTER.attributeLabels;

        // Specialized handlers
        const handleRollSkill = (skill) => {
            if(isEditing) return;
            const roll = rollDice(skill.damageDice || skill.damage || '0');
            addLog(`Uso: ${skill.name}`, roll.total > 0 ? roll.total : 'Ativado', roll.str ? `[${roll.str}]: ${roll.rolls.join('+')}` : '', 'combat');
            if(skill.cost > 0) {
                 if (skill.costType === 'HP') {
                    if(char.currentHp > skill.cost) updateChar('currentHp', char.currentHp - skill.cost);
                    else alert("Vida insuficiente!");
                 } else {
                     if(char.currentNen >= skill.cost) updateChar('currentNen', char.currentNen - skill.cost);
                     else alert("Nen insuficiente!");
                 }
            }
        };

        const addItem = (type, parentId) => {
             const id = Math.random().toString(36).substr(2, 9);
             if (type === 'skill') {
                const category = activeTab === 'hatsus' ? 'Hatsu' : activeTab === 'combat' ? 'Combat' : 'Weapon';
                const newSkill = { id, name: 'Nova Habilidade', category, type: 'Ativa', cost: 0, costType: 'Nen', damageDice: '1d6', description: '...', imageUrl: '' };
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, skills: [...(c.skills||[]), newSkill] } : c));
             }
             if (type === 'item') {
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, inventory: [...(c.inventory||[]), {id, name: 'Item', quantity: 1}] } : c));
             }
             if (type === 'summon') {
                 const newSummon = { id, name: 'Nova Invocação', avatarUrl: '', type: 'Besta de Nen', currentHp: 10, maxHp: 10, currentNen: 5, maxNen: 5, attributes: { strength: 0, constitution: 0, intelligence: 0, charisma: 0, determination: 0, prestidigitation: 0 }, description: '...', skills: [] };
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: [...(c.summons||[]), newSummon] } : c));
             }
             if (type === 'summonSkill' && parentId) {
                const newSummonSkill = { id, name: 'Nova Habilidade', cost: 1, costType: 'Nen', damage: '1d4', description: '...' };
                const newSummons = (char.summons||[]).map(s => s.id === parentId ? { ...s, skills: [...(s.skills || []), newSummonSkill] } : s);
                handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
             }
        }
        
        const deleteItem = (collection, id, parentId) => {
             if(!confirm("Remover item?")) return;
             if (collection === 'summonSkill' && parentId) {
                 const newSummons = (char.summons||[]).map(s => s.id === parentId ? { ...s, skills: s.skills.filter(k => k.id !== id) } : s);
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, summons: newSummons } : c));
             } else {
                 const list = char[collection] || [];
                 handleStateUpdate(prev => prev.map(c => c.id === activeCharId ? { ...c, [collection]: list.filter(i => i.id !== id) } : c));
             }
        }

        const handleFileUpload = async (e) => {
            const file = e.target.files?.[0];
            if(file && uploadTarget) {
                try {
                    const res = await resizeImage(file);
                    if (uploadTarget.type === 'avatar') updateChar('avatarUrl', res);
                    else if (uploadTarget.type === 'skill') updateNested('skills', uploadTarget.id, { imageUrl: res });
                    else if (uploadTarget.type === 'summon') updateNested('summons', uploadTarget.id, { avatarUrl: res });
                    else if (uploadTarget.type === 'equippedWeapon') updateNested('equippedWeapon', 'imageUrl', res);
                    else if (uploadTarget.type === 'attribute') {
                        const newMeta = { ...char.attributeMetadata, [uploadTarget.key]: { imageUrl: res } };
                        updateChar('attributeMetadata', newMeta);
                    }
                } catch (error) { console.error(error); } 
                finally { setUploadTarget(null); }
            }
        }

        const triggerUpload = (target) => { setUploadTarget(target); fileInputRef.current?.click(); }

        if (loading) return <div className="h-screen w-full flex items-center justify-center bg-black text-white font-tech animate-pulse">BOOTING SYSTEM...</div>;

        return (
            <div className={`min-h-screen relative text-gray-200 font-body ${isEditing ? 'edit-mode' : ''}`} style={{ '--theme-color': themeColor }}>
                <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept="image/*" />
                
                <CalculatorModal isOpen={!!calculatorTarget} onClose={() => setCalculatorTarget(null)} target={calculatorTarget} onConfirm={(delta) => {
                    if (!calculatorTarget) return;
                    const { type, id, field, current, max, label } = calculatorTarget;
                    let newValue = Math.max(0, Math.min(max, current + delta));
                    const isGain = delta > 0;
                    addLog(`Calculadora: ${label}`, newValue, `${isGain?'Recuperado':'Gasto'}: ${Math.abs(delta)}`, 'info');
                    if (type === 'char') updateChar(field, newValue);
                    else if (type === 'summon') {
                        const newSummons = char.summons.map(s => s.id === id ? {...s, [field]: newValue} : s);
                        updateChar('summons', newSummons);
                    }
                }} />

                {/* Navbar */}
                <div className="sticky top-0 z-50 bg-[#0a0a0c]/80 backdrop-blur-xl border-b border-white/5 px-4 py-3 flex justify-between items-center shadow-2xl">
                    <div className="flex items-center gap-4 cursor-pointer" onClick={() => setIsCharModalOpen(true)}>
                        <div className="w-10 h-10 flex items-center justify-center bg-white/5 rounded border border-white/10 tech-border relative z-10 box-glow hover:border-theme/50 transition-colors">
                            <span className="font-title text-theme text-2xl font-bold select-none text-glow">H</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="font-tech text-[10px] font-bold tracking-[0.3em] text-gray-500 uppercase">Sistema Hunter</span>
                            <span className="font-bold text-white text-sm tracking-widest uppercase text-glow">{char.nickname}</span>
                        </div>
                    </div>
                    <div className="flex gap-3 relative z-10">
                        <button onClick={() => setIsCharModalOpen(true)} className="p-2.5 text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-full transition-all"><Users size={18}/></button>
                        <button onClick={isEditing ? handleSave : () => setIsEditing(true)} className={`px-5 py-2 rounded text-xs font-bold uppercase tracking-wider border transition-all shadow-lg ${isEditing ? 'bg-white text-black border-white' : 'bg-theme/10 text-theme border-theme/50 hover:bg-theme hover:text-white'}`}>
                            {isEditing ? (isSaving ? 'Salvando...' : 'Salvar') : 'Editar'}
                        </button>
                    </div>
                </div>

                <div className="relative z-10 max-w-7xl mx-auto p-4 md:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8 pb-16">
                    {/* Left Column */}
                    <div className="lg:col-span-4 flex flex-col gap-8">
                        {/* Avatar */}
                        <div className="glass-panel group relative overflow-hidden" style={{ minHeight: '500px' }}>
                            <div className="h-[450px] w-full bg-black relative">
                                <img src={char.avatarUrl} className="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-all duration-700 scale-100 group-hover:scale-105 filter contrast-125 relative z-10"/>
                                <div className="absolute inset-0 bg-theme opacity-10 filter blur-xl animate-aura"></div>
                                <div className="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent z-20"></div>
                                {isEditing && <button onClick={() => triggerUpload({type:'avatar'})} className="absolute top-4 right-4 p-3 bg-black/50 backdrop-blur text-white rounded hover:bg-white hover:text-black border border-white/20 z-30 shadow-lg"><Upload size={20}/></button>}
                                <div className="absolute bottom-6 left-6 right-6 z-30">
                                    <div className="px-3 py-1 bg-theme text-black font-bold text-[10px] uppercase tracking-widest inline-block mb-2 rounded shadow-[0_0_10px_var(--theme-color)]">License No. {char.id.substring(0,6)}</div>
                                    {isEditing ? <input value={char.nickname} onChange={e => updateChar('nickname', e.target.value)} className="bg-black/50 backdrop-blur border-b border-white/50 text-4xl font-title text-white w-full px-2 py-1"/> : <h1 className="text-5xl font-title text-white drop-shadow-lg leading-tight tracking-wide text-glow" style={{textShadow: `0 0 20px ${themeColor}`}}>{char.nickname}</h1>}
                                    <div className="flex items-center gap-3 mt-3">
                                        <div className="h-[2px] bg-white/50 w-12"></div>
                                        <span className="text-xs font-tech text-theme uppercase tracking-[0.3em] font-bold text-glow">{char.nenType}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-[#101012] px-6 py-4 border-t border-white/10 flex justify-between items-center font-mono text-xs relative z-20">
                                <div className="flex items-center gap-3"><span className="text-gray-500 font-tech tracking-widest text-[10px]">RANK</span>
                                    {isEditing ? <input type="number" value={char.hunterLevel} onChange={(e) => updateChar('hunterLevel', parseInt(e.target.value) || 0)} className="w-12 text-center text-white bg-white/5 border-b border-white/20"/> : <div className="text-white text-xl font-bold">{char.hunterLevel}</div>}
                                </div>
                                <div className="flex-1 ml-6 text-right">
                                    <div className="flex justify-between text-[9px] uppercase text-gray-500 mb-1 tracking-wider"><span>Experience</span><span>{char.xp} / {char.maxXp} XP</span></div>
                                    <div className="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-theme shadow-[0_0_15px_var(--theme-color)] relative" style={{width: `${Math.min(100, (char.xp/char.maxXp)*100)}%`}}></div></div>
                                </div>
                            </div>
                            <div className="p-6 grid grid-cols-2 gap-y-4 gap-x-4 text-sm font-mono bg-[#0d0d10] border-t border-white/5 relative z-10">
                                {[{l:'Idade',k:'age'},{l:'Altura',k:'height'},{l:'Peso',k:'weight'},{l:'Origem',k:'nationality'}].map(f => (
                                    <div key={f.k} className="flex flex-col"><span className="text-gray-600 text-[9px] uppercase tracking-widest mb-1">{f.l}</span>
                                    {isEditing ? <input value={char[f.k]} onChange={e => updateChar(f.k, e.target.value)} className="w-full text-gray-200"/> : <span className="text-gray-300 font-bold">{char[f.k]}</span>}</div>
                                ))}
                            </div>
                        </div>
                        {/* Nen Type */}
                        <div className="glass-panel p-8 flex flex-col items-center relative overflow-visible hover:border-theme/50 transition-colors">
                            <div className="flex justify-between w-full items-center mb-6 relative z-10">
                                <span className="text-xs font-tech uppercase tracking-[0.2em] text-gray-400 flex items-center gap-2"><Activity size={14} className="text-theme"/> Afinidade de Nen</span>
                                {isEditing && <select value={char.nenType} onChange={e => updateChar('nenType', e.target.value)} className="bg-black/50 border border-white/20 text-white text-[10px] p-1 uppercase rounded z-20 relative">{Object.values(NenType).map(k => <option key={k} value={k}>{k}</option>)}</select>}
                            </div>
                            <NenHexagon activeType={char.nenType} size={240} />
                        </div>
                    </div>

                    {/* Right Column */}
                    <div className="lg:col-span-8 flex flex-col gap-8">
                        <div className="grid grid-cols-1 md:grid-cols-[1fr_1.5fr] gap-6">
                            <div className="flex flex-col gap-6">
                                <div className="glass-panel p-6 flex flex-col justify-center gap-6 relative overflow-hidden neon-border">
                                    <StatBar label="Vitalidade (HP)" current={char.currentHp} max={char.maxHp} color="#ef4444" icon={<Heart size={14}/>} isEditing={isEditing} onChange={v => updateChar('currentHp', v)} onMaxChange={v => updateChar('maxHp', v)} onOpenCalculator={() => setCalculatorTarget({type:'char', id:char.id, field:'currentHp', label:'Vitalidade', current:char.currentHp, max:char.maxHp})} />
                                    <StatBar label="Aura (Nen)" current={char.currentNen} max={char.maxNen} color={themeColor} icon={<Zap size={14}/>} isEditing={isEditing} onChange={v => updateChar('currentNen', v)} onMaxChange={v => updateChar('maxNen', v)} onOpenCalculator={() => setCalculatorTarget({type:'char', id:char.id, field:'currentNen', label:'Aura', current:char.currentNen, max:char.maxNen})} />
                                    
                                    <div className="mt-2 flex items-center justify-between bg-black/30 p-4 rounded border border-white/5 relative overflow-hidden group hover:border-blue-500/30 transition-all duration-500 shadow-[inset_0_0_20px_rgba(0,0,0,0.5)]">
                                        <div className="flex items-center gap-4 relative z-10">
                                            <ShieldCheck size={34} className="text-blue-400"/>
                                            <div className="flex flex-col"><span className="text-[10px] font-tech text-blue-400 uppercase tracking-widest font-bold text-glow">Defesa</span><span className="text-[9px] text-gray-500 uppercase tracking-wider">Armor Class</span></div>
                                        </div>
                                        {isEditing ? <input type="number" value={char.ca} onChange={e => updateChar('ca', parseInt(e.target.value))} className="w-20 bg-transparent text-white text-right font-bold text-4xl border-b border-white/20 relative z-20 font-title"/> : <span className="text-5xl font-title text-white relative z-20 drop-shadow-[0_0_10px_rgba(96,165,250,0.8)] pr-2" style={{textShadow: '0 0 20px rgba(59,130,246,0.6)'}}>{char.ca}</span>}
                                    </div>

                                    {/* Conditions */}
                                    <div className="bg-black/30 p-4 rounded border border-white/5 relative min-h-[80px]">
                                        <div className="flex items-center justify-between mb-3">
                                            <span className="text-[10px] font-tech text-gray-500 uppercase tracking-widest flex items-center gap-2"><AlertCircle size={12}/> Status Atuais</span>
                                            {isEditing && (
                                                <div className="flex items-center gap-1 relative z-20">
                                                    <input value={conditionInput} onChange={e => setConditionInput(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && conditionInput) { updateChar('conditions', [...char.conditions, conditionInput]); setConditionInput(""); }}} placeholder="Add..." className="bg-black/50 border border-white/10 text-[10px] text-white px-2 py-1 w-20 outline-none rounded"/>
                                                    <button onClick={() => { if(conditionInput) { updateChar('conditions', [...char.conditions, conditionInput]); setConditionInput(""); }}} className="bg-theme text-[10px] text-white px-2 py-1 rounded hover:bg-white hover:text-black transition-colors font-bold">+</button>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex flex-wrap gap-2 relative z-10">
                                            {(char.conditions || []).map((cond, idx) => (
                                                <span key={idx} className="text-[10px] font-bold px-3 py-1 bg-red-500/10 text-red-200 border border-red-500/20 rounded-full flex items-center gap-2">
                                                    {cond}
                                                    {isEditing && <button onClick={() => updateChar('conditions', char.conditions.filter((_, i) => i !== idx))} className="hover:text-white"><X size={10}/></button>}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="glass-panel p-4 flex items-center justify-center hover:border-theme/50 transition-colors">
                                    <AttributesRadar attributes={char.attributes} labels={attrLabels} size={200} color={themeColor} />
                                </div>
                            </div>
                            
                            {/* Attribute Cards */}
                            <div className="glass-panel p-4">
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 h-full content-start">
                                    {Object.keys(char.attributes).map((key, index) => (
                                        <AttributeCard key={key} label={attrLabels[key] || key} value={char.attributes[key]} icon={ATTR_ICONS[key]} imageUrl={char.attributeMetadata?.[key]?.imageUrl} color={getColor(key, index)} isEditing={isEditing} 
                                            onRoll={() => { const res = Math.floor(Math.random() * 20) + 1 + char.attributes[key]; addLog(attrLabels[key], res, `1d20 + ${char.attributes[key]}`); }}
                                            onChange={(v) => updateNested('attributes', key, v)} onLabelChange={(v) => updateChar('attributeLabels', {...char.attributeLabels, [key]: v})}
                                            onUpload={() => triggerUpload({type: 'attribute', key})}
                                            onDelete={!ATTR_ICONS[key] ? () => { const {[key]: _, ...rest} = char.attributes; updateChar('attributes', rest); } : undefined}
                                        />
                                    ))}
                                    {isEditing && (
                                        <button onClick={() => { const k = `attr_${Date.now()}`; updateChar('attributes', {...char.attributes, [k]: 0}); updateChar('attributeLabels', {...char.attributeLabels, [k]: 'Novo'}); }} className="flex flex-col items-center justify-center aspect-square border-2 border-dashed border-white/10 hover:border-white/30 rounded-full group transition-all">
                                            <Plus size={32} className="text-gray-500 group-hover:text-white mb-2" />
                                            <span className="text-[9px] uppercase font-bold text-gray-600 group-hover:text-gray-300">Novo Atributo</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="glass-panel flex flex-col lg:h-[calc(100vh-8rem)] h-auto shadow-2xl neon-border overflow-hidden">
                            <div className="flex bg-black/80 border-b border-white/5 overflow-x-auto custom-scrollbar flex-shrink-0 backdrop-blur-md w-full relative z-30">
                                {[{id: 'hatsus', label: 'Hatsus', icon: Zap}, {id: 'combat', label: 'Combate', icon: Target}, {id: 'weapon', label: 'Armas', icon: Sword}, {id: 'summons', label: 'Invocações', icon: PawPrint}, {id: 'inventory', label: 'Inventário', icon: Box}, {id: 'bio', label: 'Bio', icon: ScrollText}].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-5 text-[10px] md:text-xs font-bold uppercase tracking-widest transition-all border-b-2 whitespace-nowrap outline-none flex-shrink-0 ${activeTab === tab.id ? 'text-white border-theme bg-white/5 shadow-[inset_0_-10px_20px_rgba(255,255,255,0.02)]' : 'text-gray-500 border-transparent hover:text-gray-300 hover:bg-white/5'}`}>
                                        <tab.icon size={16} className={activeTab === tab.id ? 'text-theme drop-shadow-[0_0_5px_currentColor]' : ''} /> {tab.label}
                                    </button>
                                ))}
                            </div>
                            <div className="p-6 md:p-8 flex-1 bg-gradient-to-b from-transparent to-black/30 overflow-y-auto custom-scrollbar relative z-10 pr-4">
                                {activeTab === 'weapon' && (
                                    <div className="mb-8 border border-white/10 bg-[#131316] p-6 relative group rounded-sm shadow-lg hover:border-theme/30 transition-colors">
                                        <div className="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                            <h3 className="text-xs font-tech uppercase tracking-widest text-theme flex items-center gap-2"><Sword size={16}/> Arma Equipada</h3>
                                            {!isEditing && equippedWeapon.damage && <span className="text-xs font-mono text-gray-500 bg-black/30 px-2 py-1 rounded">Dano Base: {equippedWeapon.damage}</span>}
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-6">
                                            <div className="w-full md:w-48 h-48 bg-black/40 relative border border-white/10 flex-shrink-0 group-hover:border-white/20 transition-colors shadow-inner">
                                                {equippedWeapon.imageUrl ? <img src={equippedWeapon.imageUrl} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-white/10"><Sword size={48}/></div>}
                                                {isEditing && <button onClick={() => triggerUpload({type: 'equippedWeapon'})} className="absolute inset-0 bg-black/70 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20"><Camera size={24}/></button>}
                                            </div>
                                            <div className="flex-1 flex flex-col">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="flex-1">
                                                        {isEditing ? <input className="w-full bg-transparent border-b border-white/20 text-2xl font-title text-white mb-2" value={equippedWeapon.name} onChange={e => updateNested('equippedWeapon', 'name', e.target.value)} placeholder="Nome da Arma"/> : <h2 className="text-2xl font-title text-white mb-2 text-glow">{equippedWeapon.name}</h2>}
                                                    </div>
                                                    {!isEditing && equippedWeapon.damage && <button onClick={() => { const r = rollDice(equippedWeapon.damage); addLog(`Ataque: ${equippedWeapon.name}`, r.total, `[${r.str}]: ${r.rolls.join('+')}`, 'combat'); }} className="ml-4 text-xs font-mono text-red-300 bg-red-500/10 px-3 py-2 border border-red-500/20 hover:bg-red-500/20 flex items-center gap-2 cursor-pointer transition-all rounded shadow-lg z-20 relative box-glow"><Dice5 size={14}/> Rolar Dano</button>}
                                                    {isEditing && <input className="bg-red-900/20 border border-red-500/20 text-sm text-red-300 w-24 px-2 py-1 text-center rounded ml-4" placeholder="Dano" value={equippedWeapon.damage} onChange={e => updateNested('equippedWeapon', 'damage', e.target.value)} />}
                                                </div>
                                                <div className="grid gap-4 mt-auto">
                                                    <div className="bg-black/20 p-3 rounded border border-white/5"><span className="text-[10px] font-bold text-gray-500 uppercase block mb-1 tracking-wider">Aparência</span>{isEditing ? <textarea className="w-full bg-transparent text-gray-300 h-20 text-sm" value={equippedWeapon.description} onChange={e => updateNested('equippedWeapon', 'description', e.target.value)}/> : <p className="text-sm text-gray-300">{equippedWeapon.description}</p>}</div>
                                                    <div className="bg-blue-900/10 p-3 rounded border border-blue-500/10"><span className="text-[10px] font-bold text-blue-400/70 uppercase flex items-center gap-1 mb-1 tracking-wider"><Sparkles size={12}/> Habilidades Especiais</span>{isEditing ? <textarea className="w-full bg-transparent text-blue-200 h-20 text-sm" value={equippedWeapon.powers} onChange={e => updateNested('equippedWeapon', 'powers', e.target.value)}/> : <p className="text-sm text-blue-200">{equippedWeapon.powers}</p>}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {['hatsus', 'combat', 'weapon'].includes(activeTab) && (
                                    <div className="space-y-6">
                                        {(char.skills||[]).filter(s => s.category.toLowerCase() === (activeTab === 'hatsus' ? 'hatsu' : activeTab)).map(skill => (
                                            <div key={skill.id} className="border border-white/5 bg-[#131316] group hover:bg-[#18181c] transition-all relative overflow-hidden flex flex-col md:flex-row rounded-sm shadow-md hover:shadow-xl hover:translate-x-1 duration-300 hover:border-theme/30">
                                                <div className="w-full md:w-48 h-48 bg-black/40 relative flex-shrink-0 border-r border-white/5 group-hover:border-white/10 transition-colors">
                                                    {skill.imageUrl ? <img src={skill.imageUrl} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"/> : <div className="w-full h-full flex items-center justify-center text-white/5"><Hexagon size={60}/></div>}
                                                    {isEditing && <button onClick={() => triggerUpload({type: 'skill', id: skill.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20"><ImageIcon size={24}/></button>}
                                                </div>
                                                <div className="p-5 flex-1 flex flex-col relative z-10">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            {isEditing ? <input className="bg-transparent border-b border-white/20 text-xl font-title text-white w-full mb-1" value={skill.name} onChange={e => updateNested('skills', skill.id, { name: e.target.value })}/> : <h4 className="font-title text-xl text-white group-hover:text-theme transition-colors cursor-pointer inline-flex items-center gap-2" onClick={() => handleRollSkill(skill)}>{skill.name} <ChevronRight size={14} className="opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all text-theme"/></h4>}
                                                            <div className="flex gap-2 items-center mt-3 flex-wrap">
                                                                {isEditing ? (
                                                                    <>
                                                                        <input type="text" value={skill.type} onChange={e => updateNested('skills', skill.id, { type: e.target.value })} className="bg-white/5 border border-white/10 text-xs text-white px-2 py-1 rounded w-20"/>
                                                                        <input type="number" value={skill.cost} onChange={e => updateNested('skills', skill.id, { cost: parseInt(e.target.value) })} className="bg-transparent text-xs text-white w-8 text-center outline-none bg-white/5 border border-white/10 rounded"/>
                                                                        <select value={skill.costType || 'Nen'} onChange={e => updateNested('skills', skill.id, { costType: e.target.value })} className="bg-black text-xs text-gray-400 outline-none uppercase font-bold"><option value="Nen">Nen</option><option value="HP">HP</option></select>
                                                                        <input type="text" value={skill.damageDice} onChange={e => updateNested('skills', skill.id, { damageDice: e.target.value })} className="bg-red-500/10 border border-red-500/20 text-xs text-red-300 px-2 py-1 text-center rounded w-16"/>
                                                                    </>
                                                                ) : (
                                                                    <><span className="text-[10px] uppercase font-bold text-gray-500 bg-white/5 border border-white/5 px-2 py-1 rounded tracking-wide">{skill.type}</span>
                                                                    {skill.cost > 0 && <span className={`text-[10px] font-mono flex items-center gap-1 px-2 py-1 border rounded ${skill.costType === 'HP' ? 'text-red-300 bg-red-900/20 border-red-500/20' : 'text-blue-300 bg-blue-900/20 border-blue-500/20'}`}>{skill.costType === 'HP' ? <Heart size={10}/> : <Zap size={10}/>} <span className="font-bold">{skill.cost}</span> {skill.costType === 'HP' ? 'HP' : 'AP'}</span>}
                                                                    {skill.damageDice && <button onClick={() => handleRollSkill(skill)} className="text-[10px] font-mono text-red-300 bg-red-500/10 px-2 py-1 border border-red-500/20 hover:bg-red-500/20 flex items-center gap-1 cursor-pointer transition-colors rounded font-bold z-20 relative box-glow"><Dice5 size={12}/> {skill.damageDice}</button>}</>
                                                                )}
                                                            </div>
                                                        </div>
                                                        {isEditing && <button onClick={() => deleteItem('skills', skill.id)} className="text-red-500 hover:text-white p-2 bg-black/50 rounded transition-colors z-20 relative"><Trash2 size={16}/></button>}
                                                    </div>
                                                    <div className="mt-4 flex-1">
                                                        {isEditing ? <textarea value={skill.description} onChange={e => updateNested('skills', skill.id, { description: e.target.value })} className="w-full bg-black/20 text-gray-300 p-3 h-24 border border-white/5 rounded text-sm"/> : <p className="text-sm text-gray-400 font-serif leading-relaxed pl-3 border-l-2 border-white/10 whitespace-pre-wrap break-words">{skill.description}</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('skill')} className="w-full py-6 border border-dashed border-white/10 text-sm font-bold uppercase tracking-widest text-gray-500 hover:text-white hover:border-white transition-all hover:bg-white/5 rounded">+ Adicionar Técnica</button>}
                                    </div>
                                )}
                                {activeTab === 'summons' && (
                                    <div className="grid grid-cols-1 gap-10">
                                        {isEditing && <button onClick={() => addItem('summon')} className="w-full py-5 mb-4 border border-dashed border-theme/50 text-theme bg-theme/5 hover:bg-theme/10 rounded font-bold uppercase tracking-widest flex items-center justify-center gap-3 transition-all text-sm group"><Plus size={18} className="group-hover:scale-110 transition-transform"/> Criar Nova Besta de Nen</button>}
                                        {(char.summons||[]).map(summon => (
                                            <div key={summon.id} className="border border-white/5 bg-black/20 overflow-hidden group rounded-sm shadow-xl relative z-10 hover:border-theme/30 transition-all">
                                                <div className="flex flex-col md:flex-row border-b border-white/5">
                                                    <div className="w-full md:w-56 h-56 bg-black/40 relative flex-shrink-0 border-r border-white/10">
                                                        {summon.avatarUrl ? <img src={summon.avatarUrl} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"/> : <div className="w-full h-full flex items-center justify-center text-white/10"><PawPrint size={64}/></div>}
                                                        {isEditing && <button onClick={() => triggerUpload({type: 'summon', id: summon.id})} className="absolute inset-0 bg-black/60 opacity-0 hover:opacity-100 flex items-center justify-center text-white transition-opacity backdrop-blur-sm z-20"><ImageIcon size={28}/></button>}
                                                    </div>
                                                    <div className="p-6 flex-1 flex flex-col justify-center">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div className="flex-1">
                                                                {isEditing ? <input value={summon.name} onChange={e => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, name: e.target.value} : s); updateChar('summons', updated); }} className="bg-transparent border-b border-white/20 text-3xl font-title text-white w-full"/> : <h4 className="font-bold text-white text-3xl font-title tracking-wide text-glow">{summon.name}</h4>}
                                                                {isEditing ? <input value={summon.type} onChange={e => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, type: e.target.value} : s); updateChar('summons', updated); }} className="bg-black/30 border border-white/10 text-xs text-gray-400 w-full mt-2 p-1 uppercase"/> : <span className="text-xs uppercase font-bold text-gray-500 mt-2 block tracking-[0.2em]">{summon.type}</span>}
                                                            </div>
                                                            {isEditing && <button onClick={() => deleteItem('summons', summon.id)} className="text-red-500 hover:text-white p-2 bg-white/5 rounded z-20 relative"><Trash2 size={20}/></button>}
                                                        </div>
                                                        {isEditing ? <textarea value={summon.description} onChange={e => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, description: e.target.value} : s); updateChar('summons', updated); }} className="w-full h-24 bg-black/30 text-xs text-gray-400 p-3 border border-white/10 resize-y rounded"/> : <p className="text-sm text-gray-400 italic leading-relaxed border-l-2 border-white/10 pl-4 whitespace-pre-wrap break-words">{summon.description}</p>}
                                                    </div>
                                                </div>
                                                <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 bg-black/40 border-b border-white/5">
                                                    <div className="flex flex-col justify-center gap-2">
                                                        <StatBar label="HP" current={summon.currentHp} max={summon.maxHp} color="#ef4444" icon={<Heart size={12}/>} isEditing={isEditing}
                                                            onChange={v => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, currentHp: v} : s); updateChar('summons', updated); }}
                                                            onMaxChange={v => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, maxHp: v} : s); updateChar('summons', updated); }}
                                                            onOpenCalculator={() => setCalculatorTarget({type:'summon', id:summon.id, field:'currentHp', label:`HP (${summon.name})`, current:summon.currentHp, max:summon.maxHp})}
                                                        />
                                                        <StatBar label="Nen" current={summon.currentNen} max={summon.maxNen} color={themeColor} icon={<Zap size={12}/>} isEditing={isEditing}
                                                                onChange={v => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, currentNen: v} : s); updateChar('summons', updated); }}
                                                                onMaxChange={v => { const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, maxNen: v} : s); updateChar('summons', updated); }}
                                                                onOpenCalculator={() => setCalculatorTarget({type:'summon', id:summon.id, field:'currentNen', label:`Nen (${summon.name})`, current:summon.currentNen, max:summon.maxNen})}
                                                        />
                                                    </div>
                                                    <div className="flex items-center justify-center relative py-4">
                                                        <div className="scale-100 origin-center"><AttributesRadar attributes={summon.attributes} labels={{}} size={160} color={themeColor} /></div>
                                                        {isEditing && (
                                                            <div className="absolute inset-0 bg-black/90 flex flex-wrap content-center justify-center gap-2 p-4 z-20 rounded">
                                                                {Object.entries(summon.attributes).map(([key, val]) => (
                                                                    <div key={key} className="flex flex-col items-center bg-white/10 p-2 rounded w-16"><span className="text-[9px] uppercase mb-1 text-gray-400 font-bold">{key.substring(0,3)}</span><input type="number" value={val} onChange={e => { const newAttrs = {...summon.attributes, [key]: parseInt(e.target.value) || 0}; const updated = (char.summons||[]).map(s => s.id === summon.id ? {...s, attributes: newAttrs} : s); updateChar('summons', updated); }} className="w-full bg-transparent text-center text-white text-sm font-bold"/></div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                {activeTab === 'inventory' && (
                                    <div className="grid grid-cols-1 gap-1">
                                        {(char.inventory || []).map(item => (
                                            <div key={item.id} className="flex justify-between items-center p-4 bg-[#131316] border-l-2 border-transparent hover:border-theme transition-all group relative z-10 hover:bg-white/5">
                                                <div className="flex items-center gap-4 flex-1">
                                                    <div className="p-2 bg-black/30 rounded text-gray-500 group-hover:text-white transition-colors"><Box size={18}/></div>
                                                    {isEditing ? <input value={item.name} onChange={e => updateNested('inventory', item.id, { name: e.target.value })} className="bg-transparent text-white border-b border-white/20 outline-none w-full text-sm"/> : <span className="font-mono text-sm text-gray-300 group-hover:text-white transition-colors break-words">{item.name}</span>}
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    {isEditing ? <input type="number" value={item.quantity} onChange={e => updateNested('inventory', item.id, { quantity: parseInt(e.target.value) })} className="w-12 bg-white/5 text-center text-white text-sm py-1 rounded"/> : <span className="font-mono text-xs text-theme bg-theme/10 border border-theme/20 px-3 py-1 rounded">x{item.quantity}</span>}
                                                    {isEditing && <button onClick={() => deleteItem('inventory', item.id)} className="text-gray-600 hover:text-red-400 p-1 z-20 relative"><Trash2 size={16}/></button>}
                                                </div>
                                            </div>
                                        ))}
                                        {isEditing && <button onClick={() => addItem('item')} className="w-full py-4 border border-dashed border-white/10 text-sm font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-colors mt-4">+ Adicionar Item</button>}
                                    </div>
                                )}
                                {activeTab === 'bio' && (
                                    isEditing ? <textarea className="w-full h-96 bg-black/20 border border-white/10 p-6 text-gray-300 font-serif leading-loose outline-none resize-y custom-scrollbar overflow-y-auto text-base rounded" value={char.bio} onChange={e => updateChar('bio', e.target.value)} /> :
                                    <div className="glass-panel p-8 text-gray-300 font-serif text-lg leading-loose whitespace-pre-wrap shadow-inner bg-black/40 text-justify break-words">
                                        <span className="text-6xl float-left mr-4 mt-[-10px] font-title text-theme opacity-50">{char.bio.charAt(0)}</span>
                                        {char.bio.substring(1)}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Console */}
                        <div className={`glass-panel border-t border-white/10 p-4 font-mono text-xs shadow-[0_-10px_40px_rgba(0,0,0,0.8)] z-20 flex-shrink-0 flex flex-col transition-all duration-300 ${consoleExpanded ? 'h-56' : 'h-14'}`}>
                            <div className="flex flex-wrap items-center justify-between mb-3 w-full gap-3 pb-2 border-b border-white/5 flex-shrink-0">
                                <span className="flex items-center gap-2 text-theme font-bold uppercase tracking-wider text-[10px] animate-pulse-slow"><Terminal size={14}/> Console de Batalha</span>
                                <div className="flex gap-4 items-center">
                                    {consoleExpanded && <div className="flex items-center gap-1 bg-white/5 rounded px-2 py-1">{[4,6,8,10,12,20,100].map(d => <button key={d} onClick={() => { const r = Math.floor(Math.random()*d)+1; addLog(`d${d}`, r, 'Rolagem'); }} className="text-[10px] text-gray-400 hover:text-white hover:bg-white/10 px-1.5 py-0.5 rounded transition-colors active:scale-90 font-bold z-20 relative">d{d}</button>)}</div>}
                                    {consoleExpanded && <button onClick={() => { const healHp=Math.floor(char.maxHp*0.2); const healNen=Math.floor(char.maxNen*0.2); updateChar('currentHp',Math.min(char.maxHp,char.currentHp+healHp)); updateChar('currentNen',Math.min(char.maxNen,char.currentNen+healNen)); addLog('Descanso','Recuperado',`+${healHp} HP, +${healNen} AP`); }} className="text-[10px] text-green-400 hover:text-white hover:bg-green-600 flex items-center gap-1 bg-green-900/20 px-3 py-1.5 rounded border border-green-500/20 font-bold uppercase tracking-wider transition-all z-20 relative box-glow"><BatteryCharging size={12}/> Descansar</button>}
                                    <button onClick={() => setConsoleExpanded(!consoleExpanded)} className="text-gray-500 hover:text-white transition-colors">{consoleExpanded ? <ChevronDown size={16} /> : <ChevronUp size={16} />}</button>
                                </div>
                            </div>
                            {consoleExpanded && (
                                <div className="space-y-1 pl-1 overflow-y-auto custom-scrollbar flex-1">
                                    {logs.slice().reverse().map(log => (
                                        <div key={log.id} className="flex gap-3 animate-fade-in border-l-2 border-transparent hover:border-theme transition-colors py-1 hover:bg-white/5 px-2 rounded-r group">
                                            <span className="text-gray-600 text-[10px] self-center w-12 text-right opacity-50">[{log.time.toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit'})}]</span>
                                            <div className="flex-1 flex gap-2 items-baseline"><span className={`font-bold uppercase text-[11px] tracking-wide ${log.type === 'crit' ? 'text-yellow-400 text-glow' : log.type === 'fail' ? 'text-red-500' : 'text-blue-400'}`}>{log.title}:</span><span className="text-white font-bold text-sm group-hover:text-glow">{log.result}</span><span className="text-gray-500 text-xs">- {log.detail}</span></div>
                                        </div>
                                    ))}
                                    <div ref={logsEndRef} />
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {isCharModalOpen && (
                    <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                        <div className="tech-border bg-[#0a0a0c] w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl relative">
                            <div className="p-6 border-b border-white/10 flex justify-between items-center bg-[#0e0e10]">
                                <h2 className="font-tech text-2xl text-white uppercase tracking-widest flex items-center gap-3"><Users size={24} className="text-theme"/> Banco de Dados</h2>
                                <button onClick={() => setIsCharModalOpen(false)} className="p-2 bg-white/5 hover:bg-white/10 rounded-full transition-colors z-20 relative"><X size={24} className="text-gray-400 hover:text-white"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 relative z-10">
                                {characters.map(c => (
                                    <div key={c.id} onClick={() => { setActiveCharId(c.id); setIsCharModalOpen(false); }} className={`p-6 border cursor-pointer hover:bg-white/5 transition-all flex flex-col gap-3 relative group rounded-sm ${c.id === activeCharId ? 'border-theme bg-theme/5 shadow-[0_0_20px_rgba(155,89,182,0.1)]' : 'border-white/10'}`}>
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-title text-2xl text-white group-hover:text-theme transition-colors">{c.nickname}</h3>
                                            <div className="flex items-center gap-2">{c.id === activeCharId && <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_#2ecc71]"></div>}{isEditing && <button onClick={(e) => {e.stopPropagation(); handleDelete(c.id);}} className="text-gray-600 hover:text-red-500"><Trash2 size={12}/></button>}</div>
                                        </div>
                                        <div className="h-[1px] w-full bg-white/10 group-hover:bg-white/20 transition-colors"></div>
                                        <div className="flex justify-between items-end">
                                            <div className="flex flex-col"><span className="text-xs font-mono text-gray-400">{c.name}</span><span className="text-[10px] text-gray-600 mt-1">Lvl {c.hunterLevel}</span></div>
                                            <span className="text-[10px] uppercase font-bold text-gray-500 bg-black/30 px-2 py-1 rounded tracking-widest">{c.nenType.split(' ')[0]}</span>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={() => {
                                    const newChar = {...INITIAL_CHARACTER, id: generateUUID(), nickname: 'Novo Hunter', name: 'Desconhecido'};
                                    setCharacters(prev => [...prev, newChar]);
                                    setActiveCharId(newChar.id);
                                    setIsCharModalOpen(false);
                                }} className="border-2 border-dashed border-white/10 flex flex-col items-center justify-center p-6 text-gray-600 hover:text-white hover:border-white/30 transition-all group rounded-sm hover:bg-white/5 relative z-20"><Plus size={32} className="mb-3 group-hover:scale-110 transition-transform text-theme opacity-50 group-hover:opacity-100"/> <span className="text-xs font-bold uppercase tracking-widest">Nova Ficha</span></button>
                            </div>
                            <div className="p-4 text-center text-[10px] text-gray-600 font-mono uppercase border-t border-white/10 bg-[#0e0e10] flex items-center justify-center gap-2"><Lock size={10} /> Acesso Restrito • Schrodinger Corp.</div>
                        </div>
                    </div>
                )}
            </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>